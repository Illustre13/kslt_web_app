{% extends 'layouts/base.html' %}

{% block title %} Contribute {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
  .carousel-indicators li{
    filter: invert(100%);
}

.carousel-caption li,p {
  color: rgb(12, 12, 67);
  background-color: transparent;
}
.carousel-control-next,
.carousel-control-prev /*, .carousel-indicators */ {
    filter: invert(100%);
}
</style>

{% endblock stylesheets %}

{% block content %}

    <div class="container-fluid py-4">

      <div class="row">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Signs available</p>
                    <h5 id="signs_available" class="font-weight-bolder mb-0">
                      
                      <span class="text-success text-sm font-weight-bolder"></span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-ruler-pencil text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold"> Onprogress signs</p>
                    <h5 class="font-weight-bolder mb-0">
                     --
                      <span class="text-warning text-sm font-weight-bolder">not implemented</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-archive-2 text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Accuracy</p>
                    <h5 class="font-weight-bolder mb-0">
                     0.84
                      <span class="text-warning text-sm font-weight-bolder">84%</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-satisfied text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-3 col-sm-6">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Visitors</p>
                    <h5 class="font-weight-bolder mb-0">
                      --
                      <span class="text-warning text-sm font-weight-bolder">not implemented</span>
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                    <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
 
      <div class="row my-4">
        <div class="col-lg-4 col-md-6">
          <div id="myCarousel" class="carousel slide" data-bs-ride="carousel">
            <!-- Indicators -->
            <ol class="carousel-indicators">
              <li data-bs-target="#myCarousel" data-bs-slide-to="0" class="active"></li>
              <li data-bs-target="#myCarousel" data-bs-slide-to="1"></li>
              <li data-bs-target="#myCarousel" data-bs-slide-to="2"></li>
              <li data-bs-target="#myCarousel" data-bs-slide-to="3"></li>
            </ol>
            <!-- Slides -->
            <div class="carousel-inner">
              <div class="carousel-item active">
                <img src="{{ url_for('static', filename='assets/img/custom_card_kslt.png') }}" class="d-block w-100" alt="Slide 1">
                <div class="carousel-caption">
                  <p class=" mb-0">
                  Upload a video of a   Kinyarwanda Sign Language sign. The uploaded Video will be used to train the models, they shall not be used for for any other purposes like publications and so forth. Provide an appriate word for the sign video.                  
                  </p>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                </div>
              </div>
              <div class="carousel-item">
                <img src="{{ url_for('static', filename='assets/img/custom_card_kslt.png') }}" class="d-block w-100" alt="Slide 1">
                <div class="carousel-caption">
                  <h6>How to Contribute</h6>
                  <h5>1<sup>st</sup></h5>
                  <p> Ensure you are knowledgeable about Kinyarwanda sign language and the word you want to demonstrate.</p>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                </div>
              </div>
              <div class="carousel-item">
                <img src="{{ url_for('static', filename='assets/img/custom_card_kslt.png') }}" class="d-block w-100" alt="Slide 2">
                <div class="carousel-caption">
                  <h6>How to Contribute</h6>
                  <h5>2<sup>nd</sup></h5>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item text-sm">Type the Kinyarwanda word you want to sign in the text input field.</li>
                    <li class="list-group-item text-sm">Select the video using the file input field.</li>
                  </ul>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                </div>
              </div>
              <div class="carousel-item">
                <img src="{{ url_for('static', filename='assets/img/custom_card_kslt.png') }}" class="d-block w-100" alt="Slide 3">
                <div class="carousel-caption">
                  <h6>How to Contribute</h6>
                  <h5>3<sup>rd</sup></h5>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item text-sm" >Preview the recorded video to ensure that it is clear and the sign is demonstrated properly.</li>
                    <li class="list-group-item text-sm">Click the submit button.</li>
                  </ul>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                  <br>
                </div>
              </div>
            </div>
          
            <!-- Controls -->
            <a class="carousel-control-prev" href="#myCarousel" role="button" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </a>
            <a class="carousel-control-next" href="#myCarousel" role="button" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </a>
          </div>            
        </div>
        <div class="col-lg-8 col-md-6 mb-md-0 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <div class="row">
                <div class="col-lg-12 col-7">
                  <h6>Sign Video Upload</h6>
                </div>
              </div>
            </div>
            <div class="card-body px-3 pb-2">
              <form method="POST" enctype="multipart/form-data" action="/contribute" onsubmit="return validateForm()">
                <div class ="row">
                  <div class="col-lg-4 mb-3">
                    <input class="form-control" id="input_word" name="input_word" rows="3", placeholder="Kinyarwanda word"></input>
                    <div id="error" style="color: red;"></div>
                  </div> 
                  <div class="col-lg-6 mb-3">
                      <input  class="form-control" type="file" id="video" name="video" accept="video/*" >
                  </div> 
                  <div class="col-lg-2 mb-3">
                    <button type="submit" class="btn bg-gradient-dark mb-0">Submit</button>
                  </div> 
                </div>
              </form>            
            </div>
            <div class="px-3" >
              <video id="videoPreview"  height="480"  width="854" controls></video>
            </div>
            
          </div>
        </div>
        </div>
      </div>

      {% include "includes/footer.html" %}

    </div>

{% endblock content %}

{% block javascripts %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script type="text/javascript">

  const videoInput = document.getElementById('video');
  const videoPreview = document.getElementById('videoPreview');
  let available_words;
  var validInput;

  const MAX_WIDTH = 640;
  const MAX_HEIGHT = 480;

  console.log("Adding event listener");
  
  document.getElementById("input_word").addEventListener("input", validateInput);


  
  videoInput.addEventListener('change', function() {
    const file = this.files[0];
    const fileURL = URL.createObjectURL(file);
    videoPreview.src = fileURL;
  });
    
  function fetchLabels() {
      // Send an AJAX request to fetch the available labels
      $.ajax({
          url: '/fetch_available_labels',
          method: 'GET',
          success: function(data) {
              // Update the UI with the labels data

              var percentage = (data.labelCount / 30000) * 100;
              var rounded_percentage = percentage.toFixed(4);
              

              available_words = data.availableLabels.map(arr => arr[0]);
              $('#signs_available').html(data.labelCount + '   <span class="text-success text-sm font-weight-bolder">'+ rounded_percentage +'%</span>');
          },
          error: function(xhr, status, error) {
              console.log('Error fetching labels:', error);
          }
      });
  }
  
  fetchLabels()

  function validateInput() {
    const input = document.getElementById("input_word").value.trim(); // get user input and remove leading/trailing white spaces
    const error = document.getElementById("error");
    const isPresent = available_words.includes(input); // check if input is in the list of valid words
    const feedback = document.getElementById("feedback"); // get the feedback element
     

  if (isPresent) {
    error.innerHTML = "Sign Present in the system, Choose another word to contribute";
    validInput=false;
  } else {
    error.innerHTML = "";
    validInput=true;
  }
}


document.getElementById("input_word").addEventListener("input", validateInput);


function validateForm() {
        const video = document.getElementById("video");
        const text = document.getElementById("input_word");


        if (video.value !== "" && text.value !== "") {
          if (validInput){
            return true;
          }else{
            alert("Please contribute on another sign");
            return false;
          }
        }else{
          alert("Please select a video and enter appropiate word.");
          return false;
        }
}


</script>
 
{% endblock javascripts %}
